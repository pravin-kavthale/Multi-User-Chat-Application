{% extends "base/base.html" %}
{% load static %}
{% block title %}Chat Room{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto mt-12 p-6 bg-gray-100 dark:bg-gray-900 rounded-xl shadow-lg">
    <h2 class="text-3xl font-bold mb-6 text-gray-800 dark:text-gray-100">Chat with Bot</h2>

    <!-- Chat log -->
    <div id="chat-log" class="h-96 overflow-y-auto p-4 bg-white dark:bg-gray-800 rounded-lg shadow-inner mb-4 flex flex-col space-y-3">
        <!-- Messages will be appended here -->
    </div>

    <!-- Chat input -->
    <form id="chat-form" class="flex">
        <input id="chat-message-input" type="text" placeholder="Type a message..."
               class="flex-1 border border-gray-300 dark:border-gray-600 rounded-l px-4 py-2 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 bg-white dark:bg-gray-700"/>
        <button type="submit"
                class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-2 rounded-r font-semibold transition">
            Send
        </button>
    </form>
</div>

<!-- JS to connect WebSocket -->
<script>
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const chatSocket = new WebSocket(
        wsScheme + '://' + window.location.host + '/ws/chat/' + "{{ request.user.username }}/"
    );


    const chatLog = document.querySelector('#chat-log');
    const chatForm = document.querySelector('#chat-form');
    const chatInput = document.querySelector('#chat-message-input');

    // Scroll chat to bottom
    function scrollToBottom() {
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Receive messages from server
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const msgDiv = document.createElement('div');

        // Different styles for user vs bot
        if (data.role === 'user') {
            msgDiv.className = 'self-end bg-indigo-500 text-white px-4 py-2 rounded-xl max-w-xs';
        } else {
            msgDiv.className = 'self-start bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-4 py-2 rounded-xl max-w-xs';
        }

        msgDiv.textContent = data.message;
        chatLog.appendChild(msgDiv);
        scrollToBottom();
    };

    // Send message to server
    chatForm.onsubmit = function(e) {
        e.preventDefault();
        if (chatInput.value.trim() === "") return;

        chatSocket.send(JSON.stringify({
            'message': chatInput.value
        }));
        chatInput.value = '';
    };
</script>
{% endblock %}
